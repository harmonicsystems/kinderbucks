rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isAdmin() {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    function isBusiness() {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'business' ||
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin');
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function ownsBusinessCode(businessCode) {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.businessCode == businessCode;
    }

    // ==================== USERS ====================
    // Users can read their own profile
    // Only admins can write to users collection
    match /users/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow create: if isOwner(userId); // Allow initial profile creation
      allow update: if isOwner(userId) &&
        // Users can update their own profile but NOT role or businessCode
        !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'businessCode', 'isDeleted']);
      allow update, delete: if isAdmin();
    }

    // ==================== BUSINESSES ====================
    // Public read for active businesses
    // Only admins can create/delete businesses
    // Business owners can update their own business (loyalty, cross-rewards, etc.)
    match /businesses/{businessCode} {
      allow read: if true; // Public directory
      allow create, delete: if isAdmin();
      allow update: if isAdmin() || ownsBusinessCode(businessCode);
    }

    // ==================== KINDERBUCKS ====================
    // Public read for verification (scan page)
    // Only admins can create/update kinderbucks
    match /kinderbucks/{serial} {
      allow read: if true; // Public verification
      allow create, update, delete: if isAdmin();
    }

    // ==================== CHECK-INS ====================
    // Users can create their own check-ins
    // Users can read their own check-ins
    // Business owners can read check-ins for their business
    // Admins can read all
    match /checkins/{checkinId} {
      allow create: if isAuthenticated() &&
        request.resource.data.visitorId == request.auth.uid;
      allow read: if isAdmin() ||
        (isAuthenticated() && resource.data.visitorId == request.auth.uid) ||
        ownsBusinessCode(resource.data.businessCode);
      allow update, delete: if isAdmin();
    }

    // ==================== MEMBERS ====================
    // Users can read/write their own member data
    // Admins can read all
    match /members/{memberId} {
      allow read, write: if isOwner(memberId);
      allow read: if isAdmin();
    }

    // ==================== EXCHANGES ====================
    // Users can create their own exchange requests
    // Users can read their own exchanges
    // Admins can read/update all exchanges
    match /exchanges/{exchangeId} {
      allow create: if isAuthenticated() &&
        request.resource.data.visitorId == request.auth.uid;
      allow read: if isAdmin() ||
        (isAuthenticated() && resource.data.visitorId == request.auth.uid);
      allow update, delete: if isAdmin();
    }

    // ==================== TRANSACTIONS ====================
    // Business owners can create transactions for their business
    // Business owners can read their own transactions
    // Admins can read/write all
    match /transactions/{transactionId} {
      allow create: if isBusiness() &&
        ownsBusinessCode(request.resource.data.businessCode);
      allow read: if isAdmin() ||
        ownsBusinessCode(resource.data.businessCode);
      allow update, delete: if isAdmin();
    }

    // ==================== PROMO CODES ====================
    // Public read (members need to see available promos)
    // Business owners can CRUD their own promo codes
    // Admins can CRUD all
    match /promoCodes/{promoId} {
      allow read: if true; // Public for validation
      allow create: if isBusiness() &&
        ownsBusinessCode(request.resource.data.businessCode);
      allow update, delete: if isAdmin() ||
        ownsBusinessCode(resource.data.businessCode);
    }

    // ==================== REDEMPTIONS ====================
    // Business owners can create redemption requests
    // Business owners can read their own redemptions
    // Admins can read/update all
    match /redemptions/{redemptionId} {
      allow create: if isBusiness() &&
        ownsBusinessCode(request.resource.data.businessCode);
      allow read: if isAdmin() ||
        ownsBusinessCode(resource.data.businessCode);
      allow update, delete: if isAdmin();
    }

    // ==================== LANDMARKS ====================
    // Public read for scavenger hunt display
    // Only admins can create/update/delete landmarks
    match /landmarks/{landmarkCode} {
      allow read: if true; // Public for scavenger hunts
      allow create, update, delete: if isAdmin();
    }

    // ==================== HUNTS ====================
    // Public read for scavenger hunt listings
    // Only admins can create/update/delete hunts
    match /hunts/{huntId} {
      allow read: if true; // Public for scavenger hunt listings
      allow create, update, delete: if isAdmin();
    }

    // ==================== HUNT PROGRESS ====================
    // Users can read/write their own hunt progress
    // Admins can read all
    match /huntProgress/{progressId} {
      allow create: if isAuthenticated() &&
        request.resource.data.memberId == request.auth.uid;
      allow read: if isAdmin() ||
        (isAuthenticated() && resource.data.memberId == request.auth.uid);
      allow update: if isAuthenticated() &&
        resource.data.memberId == request.auth.uid;
      allow delete: if isAdmin();
    }
  }
}
